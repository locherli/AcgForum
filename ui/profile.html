<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <script src="./js/vue.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/utils.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        blue: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 min-h-screen py-8">
    <div id="app" class="max-w-4xl mx-auto">
        <!-- User Profile Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center">
                <img :src="'/uploads/' + user.avatarUrl" alt="Avatar" onerror="this.src = '/image/default-avatar.png'"
                    class="w-24 h-24 rounded-lg object-cover ">
                <div class="ml-6 flex-1">
                    <h1 class="text-2xl font-bold text-blue-600">{{ user.name || 'Anonymous User' }}</h1>
                    <p class="text-gray-600 mt-1">{{ user.selfIntro || 'No introduction yet.' }}</p>
                    <div class="mt-3 flex space-x-6 text-sm text-gray-500">
                        <span>Fans: {{ user.fanNum || 0 }}</span>
                        <span>Following: {{ user.subscribeNum || 0 }}</span>
                    </div>
                </div>
            </div>
            <button @click="editProfile"
                class="mt-6 bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md font-medium transition-colors">
                Edit Profile
            </button>
        </div>

        <!-- Navigation Tabs -->
        <nav class="bg-white rounded-lg shadow-md mb-6">
            <ul class="flex border-b border-gray-200">
                <li v-for="tab in tabs" :key="tab.id" class="flex-1">
                    <button @click="switchTab(tab.id)" :class="[
                            'w-full py-3 px-4 text-center font-medium transition-colors',
                            activeTab === tab.id
                                ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50'
                                : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                        ]">
                        {{ tab.name }}
                    </button>
                </li>
            </ul>
        </nav>

        <!-- Tab Content -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <!-- My Posts Tab -->
            <div v-if="activeTab === 'posts'">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Posts I've Written</h2>
                <div v-if="myPosts.length === 0" class="text-gray-500 text-center py-8">No posts yet.</div>
                <div v-else>
                    <div v-for="post in myPosts" :key="post.id"
                        class="mb-4 p-4 bg-gray-50 rounded-md border border-gray-200 flex justify-between items-start">

                        <a :href="'post.html?id=' + post.id" class="flex-1">
                            <h3 class="text-lg font-bold text-gray-900 mb-1">{{ post.title }}</h3>
                            <p class="text-sm text-gray-500 mb-2">{{ new Date(post.date).toLocaleDateString() }}</p>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Likes: {{ post.like }}</span>
                                <span>Comments: {{ post.commentsNum }}</span>
                            </div>
                        </a>
                        <button @click="deleteMyPost(post.id)" 
                                class="ml-4 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                            Delete
                        </button>

                    </div>
                </div>
                <div v-if="hasMorePosts" class="text-center mt-4">
                    <button @click="loadMorePosts" :disabled="loading"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors">
                        {{ loading ? 'Loading...' : 'Load More' }}
                    </button>
                </div>
            </div>

            <!-- Collected Posts Tab -->
            <div v-if="activeTab === 'collected'">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Collected Posts</h2>
                <div v-if="collectedPosts.length === 0" class="text-gray-500 text-center py-8">No collected posts yet.
                </div>
                <div v-else>
                    <div v-for="post in collectedPosts" :key="post.id"
                        class="mb-4 p-4 bg-gray-50 rounded-md border border-gray-200 flex justify-between items-start">

                        <a :href="'post.html?id=' + post.id" class="flex-1">
                            <h3 class="text-lg font-bold text-gray-900 mb-1">{{ post.title }}</h3>
                            <p class="text-sm text-gray-500 mb-2">{{ new Date(post.date).toLocaleDateString() }}</p>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Likes: {{ post.like }}</span>
                                <span>Comments: {{ post.commentsNum }}</span>
                                <span class="text-blue-600">by {{ post.authorName }}</span>
                            </div>
                            <img v-if="post.avatarUrl" :src="'/uploads/' + post.avatarUrl" alt="Author Avatar"
                                onerror="this.src='/image/default-avatar.png'" class="mt-2 w-8 h-8 rounded">
                        </a>
                        <button @click="uncollectPost(post.id)" 
                                class="ml-4 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                            Uncollect
                        </button>

                    </div>
                </div>
                <div v-if="hasMoreCollected" class="text-center mt-4">
                    <button @click="loadMoreCollected" :disabled="loading"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors">
                        {{ loading ? 'Loading...' : 'Load More' }}
                    </button>
                </div>
            </div>

            <!-- Following Tab -->
            <div v-if="activeTab === 'following'">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Users I'm Following</h2>
                <div v-if="following.length === 0" class="text-gray-500 text-center py-8">Not following anyone yet.
                </div>
                <div v-else>
                    <div v-for="u in following" :key="u.id"
                        class="mb-4 p-4 bg-gray-50 rounded-md border border-gray-200 flex justify-between items-center">

                        <a :href="'user.html?id=' + u.id" class="flex items-center flex-1">
                            <img :src="'/uploads/' + u.avatarUrl" alt="Avatar"
                                onerror="this.src='/image/default-avatar.png'"
                                class="w-12 h-12 rounded-full object-cover mr-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-900">{{ u.userName }}</h3>
                                <p class="text-gray-600 text-sm">{{ u.selfIntro || 'No introduction.' }}</p>
                                <div class="text-xs text-gray-500 mt-1">
                                    Fans: {{ u.fanNum }} | Following: {{ u.subscribeNum }}
                                </div>
                            </div>
                        </a>
                        <button @click="unsubscribeUser(u.id)" 
                                class="ml-4 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                            Unfollow
                        </button>

                    </div>
                </div>
                <div v-if="hasMoreFollowing" class="text-center mt-4">
                    <button @click="loadMoreFollowing" :disabled="loading"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors">
                        {{ loading ? 'Loading...' : 'Load More' }}
                    </button>
                </div>
            </div>

            <!-- Fans Tab -->
            <div v-if="activeTab === 'fans'">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">My Fans</h2>
                <div v-if="fans.length === 0" class="text-gray-500 text-center py-8">No fans yet.</div>
                <div v-else>
                    <div v-for="u in fans" :key="u.id"
                        class="mb-4 p-4 bg-gray-50 rounded-md border border-gray-200 flex items-center">
                        <a :href="'user.html?id=' + u.id" class="flex items-center flex-1">

                            <img :src="'/uploads/' + u.avatarUrl" alt="Avatar"
                                onerror="this.src = '/image/default-avatar.png'"
                                class="w-12 h-12 rounded-full object-cover mr-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-900">{{ u.userName }}</h3>
                                <p class="text-gray-600 text-sm">{{ u.selfIntro || 'No introduction.' }}</p>
                                <div class="text-xs text-gray-500 mt-1">
                                    Fans: {{ u.fanNum }} | Following: {{ u.subscribeNum }}
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
                <div v-if="hasMoreFans" class="text-center mt-4">
                    <button @click="loadMoreFans" :disabled="loading"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors">
                        {{ loading ? 'Loading...' : 'Load More' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                // Reactive data
                const user = ref({});
                const myPosts = ref([]);
                const collectedPosts = ref([]);
                const following = ref([]);
                const fans = ref([]);
                const activeTab = ref('posts');
                const loading = ref(false);

                const tabs = [
                    { id: 'posts', name: 'My Posts' },
                    { id: 'collected', name: 'Collected Posts' },
                    { id: 'following', name: 'Following' },
                    { id: 'fans', name: 'Fans' }
                ];

                // Pagination states
                const postsPage = ref(1);
                const collectedPage = ref(1);
                const followingPage = ref(1);
                const fansPage = ref(1);

                const hasMorePosts = ref(true);
                const hasMoreCollected = ref(true);
                const hasMoreFollowing = ref(true);
                const hasMoreFans = ref(true);

                // Login check (made async)
                const checkLogin = async () => {
                    try {
                        const response = await fetch('/is_login');
                        const result = await response.json();
                        if (!result.msg.includes('true')) {
                            alert('please login firstï¼');
                            clearCookies();
                            window.location.href = 'index.html';
                        }
                    } catch (error) {
                        console.error('Error checking login:', error);
                    }
                };

                // Fetch user
                const fetchUser = async () => {
                    try {
                        const response = await fetch(`/user/myself`);
                        if (response.ok) {
                            user.value = await response.json();
                        }
                    } catch (error) {
                        console.error('Error fetching user:', error);
                    }
                };

                // Delete my post
                const deleteMyPost = async (postId) => {
                    if (!confirm('Are you sure you want to delete this post?')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/delete_post?id=${postId}`, {
                            method: 'POST'
                        });
                        if (response.ok) {
                            // Remove from local list
                            myPosts.value = myPosts.value.filter(post => post.id !== postId);
                            alert('Post deleted successfully');
                        } else {
                            alert('Failed to delete post');
                        }
                    } catch (error) {
                        console.error('Error deleting post:', error);
                        alert('Error deleting post');
                    }
                };

                // Uncollect post
                const uncollectPost = async (postId) => {
                    if (!confirm('Are you sure you want to uncollect this post?')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/uncollect_post?userId=${user.value.id}&postId=${postId}`, {
                            method: 'POST'
                        });
                        if (response.ok) {
                            // Remove from local list
                            collectedPosts.value = collectedPosts.value.filter(post => post.id !== postId);
                            alert('Post uncollected successfully');
                        } else {
                            alert('Failed to uncollect post');
                        }
                    } catch (error) {
                        console.error('Error uncollecting post:', error);
                        alert('Error uncollecting post');
                    }
                };

                // Unsubscribe user
                const unsubscribeUser = async (userId) => {
                    if (!confirm('Are you sure you want to unfollow this user?')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/unsubscribe_user?myId=${user.value.id}&userId=${userId}`, {
                            method: 'POST'
                        });
                        if (response.ok) {
                            // Remove from local list
                            following.value = following.value.filter(user => user.id !== userId);
                            alert('Unfollowed successfully');
                        } else {
                            alert('Failed to unfollow user');
                        }
                    } catch (error) {
                        console.error('Error unfollowing user:', error);
                        alert('Error unfollowing user');
                    }
                };

                // Load more functions
                const loadMorePosts = async () => {
                    if (!hasMorePosts.value || loading.value) return;
                    loading.value = true;
                    try {
                        const response = await fetch(`/my_posts?page=${postsPage.value}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (Array.isArray(data) && data.length === 0) {
                                hasMorePosts.value = false;
                            } else {
                                myPosts.value.push(...data);
                                postsPage.value++;
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching posts:', error);
                    } finally {
                        loading.value = false;
                    }
                };

                const loadMoreCollected = async () => {
                    if (!hasMoreCollected.value || loading.value) return;
                    loading.value = true;
                    try {
                        const response = await fetch(`/my_collected_posts?page=${collectedPage.value}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (Array.isArray(data) && data.length === 0) {
                                hasMoreCollected.value = false;
                            } else {
                                collectedPosts.value.push(...data);
                                collectedPage.value++;
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching collected posts:', error);
                    } finally {
                        loading.value = false;
                    }
                };

                const loadMoreFollowing = async () => {
                    if (!hasMoreFollowing.value || loading.value) return;
                    loading.value = true;
                    try {
                        const response = await fetch(`/my_subscribed_users?page=${followingPage.value}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (Array.isArray(data) && data.length === 0) {
                                hasMoreFollowing.value = false;
                            } else {
                                following.value.push(...data);
                                followingPage.value++;
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching following:', error);
                    } finally {
                        loading.value = false;
                    }
                };

                const loadMoreFans = async () => {
                    if (!hasMoreFans.value || loading.value) return;
                    loading.value = true;
                    try {
                        const response = await fetch(`/my_fans?page=${fansPage.value}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (Array.isArray(data) && data.length === 0) {
                                hasMoreFans.value = false;
                            } else {
                                fans.value.push(...data);
                                fansPage.value++;
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching fans:', error);
                    } finally {
                        loading.value = false;
                    }
                };

                const switchTab = (tabId) => {
                    if (activeTab.value !== tabId) {
                        activeTab.value = tabId;
                        loadTabData();
                    }
                };

                const loadTabData = () => {
                    switch (activeTab.value) {
                        case 'posts':
                            if (myPosts.value.length === 0 && hasMorePosts.value) {
                                loadMorePosts();
                            }
                            break;
                        case 'collected':
                            if (collectedPosts.value.length === 0 && hasMoreCollected.value) {
                                loadMoreCollected();
                            }
                            break;
                        case 'following':
                            if (following.value.length === 0 && hasMoreFollowing.value) {
                                loadMoreFollowing();
                            }
                            break;
                        case 'fans':
                            if (fans.value.length === 0 && hasMoreFans.value) {
                                loadMoreFans();
                            }
                            break;
                    }
                };

                const editProfile = () => {
                    window.location.href = '/edit-profile.html';
                };

                onMounted(async () => {
                    await checkLogin();
                    await fetchUser();
                    loadTabData();
                });

                return {
                    user,
                    myPosts,
                    collectedPosts,
                    following,
                    fans,
                    activeTab,
                    tabs,
                    loading,
                    hasMorePosts,
                    hasMoreCollected,
                    hasMoreFollowing,
                    hasMoreFans,
                    switchTab,
                    editProfile,
                    deleteMyPost,
                    uncollectPost,
                    unsubscribeUser,
                    loadMorePosts,
                    loadMoreCollected,
                    loadMoreFollowing,
                    loadMoreFans
                };
            }
        }).mount('#app');
    </script>
</body>

</html>